<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:DreamKeeper.Services"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:data="clr-namespace:DreamKeeper.Data"
             x:Class="DreamKeeper.MainPage"
             BackgroundColor="{AppThemeBinding Light={StaticResource MoonGlow}, Dark={StaticResource NightSky}}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:BoolToRecordingTextConverter x:Key="BoolToRecordingTextConverter"/>
            <local:BoolToRecordingColorConverter x:Key="BoolToRecordingColorConverter"/>
            <local:ByteArrayToVisibilityConverter x:Key="ByteArrayToVisibilityConverter"/>
            <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <local:BoolToInvertedVisibilityConverter x:Key="BoolToInvertedVisibilityConverter"/>
        </ResourceDictionary>

        <DataTemplate x:Key="BaseMediaElementTemplate">
            <toolkit:MediaElement Grid.Column="1" Grid.ColumnSpan="3" />
        </DataTemplate>

        <DataTemplate x:Key="ByteArrayMediaElementTemplate">
            <data:ByteArrayMediaElement Grid.Column="1" Grid.ColumnSpan="3"
                                         AudioData="{Binding DreamRecording}" 
                                         ShouldShowPlaybackControls="True"/>
        </DataTemplate>

        <data:MediaElementTemplateSelector x:Key="MediaElementTemplateSelector"
                                           BaseMediaElementTemplate="{StaticResource BaseMediaElementTemplate}"
                                           ByteArrayMediaElementTemplate="{StaticResource ByteArrayMediaElementTemplate}" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto">
        <!-- Header Section -->
        <Frame Grid.Row="0" Margin="16,16,16,0" Style="{StaticResource DreamCardStyle}">
            <StackLayout Spacing="8">
                <Label Text="Dream Journal" Style="{StaticResource HeaderStyle}" />
                <Label Text="Capture your dreams and insights" Style="{StaticResource SubHeaderStyle}" />
            </StackLayout>
        </Frame>

        <!-- Search and Filter Section -->
        <Frame Grid.Row="1" Margin="16,8,16,0" Style="{StaticResource DreamCardStyle}">
            <Grid ColumnDefinitions="2*,Auto,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="0">
                <!-- Search Bar -->
                <SearchBar x:Name="searchBar"
                          Grid.Column="0"
                          Placeholder="Search dreams by title or description..."
                          Text="{Binding SearchText}"
                          SearchCommand="{Binding ClearFiltersCommand}"
                          SearchCommandParameter="{x:Null}"
                          VerticalOptions="Center" />
                
                <!-- Has Recording Filter -->
                <CheckBox x:Name="hasRecordingCheckBox"
                         Grid.Column="1"
                         IsChecked="{Binding ShowOnlyWithRecordings}"
                         Color="{StaticResource Primary}"
                         VerticalOptions="Center" />
                <Label Text="Has Recording"
                       Grid.Column="2"
                       VerticalOptions="Center"
                       FontSize="14">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnHasRecordingLabelTapped" />
                    </Label.GestureRecognizers>
                </Label>
                
                <!-- No Recording Filter -->
                <CheckBox x:Name="noRecordingCheckBox"
                         Grid.Column="3"
                         IsChecked="{Binding ShowOnlyWithoutRecordings}"
                         Color="{StaticResource Primary}"
                         VerticalOptions="Center" />
                <Label Text="No Recording"
                       Grid.Column="4"
                       VerticalOptions="Center"
                       FontSize="14">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnNoRecordingLabelTapped" />
                    </Label.GestureRecognizers>
                </Label>
                
                <!-- Clear Filters Button -->
                <Button Text="Clear Filters"
                       Grid.Column="5"
                       Command="{Binding ClearFiltersCommand}"
                       BackgroundColor="{StaticResource Secondary}"
                       TextColor="{StaticResource Black}"
                       FontSize="12"
                       CornerRadius="12"
                       HeightRequest="32"
                       Padding="12,4"
                       VerticalOptions="Center" />
            </Grid>
        </Frame>

        <!-- Dreams List -->
        <RefreshView Grid.Row="2">
            <ScrollView>
                <StackLayout Padding="16,8" Spacing="0">
                    <CollectionView ItemsSource="{Binding Dreams}"
                                   SelectionMode="Single"
                                   SelectedItem="{Binding SelectedDream}">
                        <CollectionView.EmptyView>
                            <StackLayout VerticalOptions="CenterAndExpand" HorizontalOptions="CenterAndExpand">
                                <Label Text="No dreams found" 
                                      HorizontalTextAlignment="Center"
                                      TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                                      FontSize="18" />
                                <Label Text="Try adjusting your search filters or add a new dream"
                                      HorizontalTextAlignment="Center"
                                      TextColor="{AppThemeBinding Light={StaticResource Gray400}, Dark={StaticResource Gray500}}"
                                      FontSize="14"
                                      Margin="0,8,0,0" />
                            </StackLayout>
                        </CollectionView.EmptyView>
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Style="{StaticResource DreamCardStyle}">
                                    <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto"
                                          ColumnDefinitions="*,Auto,Auto,Auto"
                                          ColumnSpacing="8"
                                          RowSpacing="8">
                                        
                                        <!-- Dream Title and Date -->
                                        <Label Text="{Binding DreamName}" 
                                               Style="{StaticResource DreamTitleStyle}"
                                               Grid.Row="0" Grid.Column="0" />
                                        
                                        <!-- Clickable Date Label -->
                                        <Label Text="{Binding DreamDate, StringFormat='{0:MMM d, yyyy}'}" 
                                               Style="{StaticResource DreamDateStyle}"
                                               Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3"
                                               IsVisible="{Binding IsEditingDate, Converter={StaticResource BoolToInvertedVisibilityConverter}}">
                                            <Label.GestureRecognizers>
                                                <TapGestureRecognizer Tapped="OnDateLabelTapped" />
                                            </Label.GestureRecognizers>
                                        </Label>

                                        <!-- DatePicker for editing -->
                                        <DatePicker Date="{Binding DreamDate}"
                                                    Grid.Row="0" Grid.Column="1" Grid.ColumnSpan="3"
                                                    HorizontalOptions="Center"
                                                    VerticalOptions="Center"
                                                    FontSize="14"
                                                    BackgroundColor="{AppThemeBinding Light={StaticResource Gray100}, Dark={StaticResource Gray800}}"
                                                    IsVisible="{Binding IsEditingDate, Converter={StaticResource BoolToVisibilityConverter}}"
                                                    DateSelected="OnDatePickerDateSelected" />

                                        <!-- Dream Description -->
                                        <Editor Text="{Binding DreamDescription}"
                                                Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="4"
                                                AutoSize="TextChanges"
                                                HeightRequest="100" />
                                        
                                        <!-- Audio Player (Hidden when no recording) -->
                                        <data:ByteArrayMediaElement x:Name="audioPlayer" 
                                                                  Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="4"
                                                                  AudioData="{Binding DreamRecording}"
                                                                  ShouldShowPlaybackControls="True"
                                                                  IsVisible="{Binding DreamRecording, Converter={StaticResource ByteArrayToVisibilityConverter}}"
                                                                  HeightRequest="40"/>

                                        <!-- Action Buttons -->
                                        <Button Grid.Row="3" Grid.Column="0"
                                                Style="{StaticResource RecordButtonStyle}"
                                                Clicked="OnToggleRecordingClicked"
                                                Text="{Binding IsRecording, Converter={StaticResource BoolToRecordingTextConverter}}"
                                                BackgroundColor="{Binding IsRecording, Converter={StaticResource BoolToRecordingColorConverter}}"
                                                HorizontalOptions="Start" />
                                        
                                        <Button Grid.Row="3" Grid.Column="1"
                                                Style="{StaticResource PlayButtonStyle}"
                                                Clicked="Button_Clicked"
                                                Text="▶️"
                                                IsEnabled="{Binding DreamRecording, Converter={StaticResource ByteArrayToVisibilityConverter}}" />
                                        
                                        <Button Grid.Row="3" Grid.Column="2"
                                                Style="{StaticResource DeleteButtonStyle}"
                                                Text="⌫"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteDreamCommand}"
                                                CommandParameter="{Binding}" />
                                        
                                        <!-- Save Button (Only visible when there are unsaved changes) -->
                                        <Button Grid.Row="4" Grid.Column="0" Grid.ColumnSpan="4"
                                                Text="💾 Save Changes"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                                TextColor="White"
                                                FontAttributes="Bold"
                                                Margin="0,8,0,0"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SaveDreamCommand}"
                                                CommandParameter="{Binding}"
                                                IsVisible="{Binding HasUnsavedChanges, Converter={StaticResource BoolToVisibilityConverter}}" />
                                    </Grid>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                        <CollectionView.ItemsLayout>
                            <LinearItemsLayout Orientation="Vertical" ItemSpacing="16" />
                        </CollectionView.ItemsLayout>
                    </CollectionView>
                </StackLayout>
            </ScrollView>
        </RefreshView>

        <!-- Floating Action Button -->
        <Button Grid.Row="3"
                Style="{StaticResource AddButtonStyle}"
                Text="+"
                Clicked="DreamAddButton_ClickedAsync"/>
    </Grid>
</ContentPage>
